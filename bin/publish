#!/usr/bin/env php
<?php

$appDir         = realpath(__DIR__ . '/../app');
$staticDir      = $appDir.'/cache/prod/static_http_cache';
$interpreter    = (PHP_OS == 'WINNT') ? 'php.exe' : 'php';

// Build static site
passthru(sprintf('%s %s/console static:build --ansi --env=prod', $interpreter, $appDir));

// Git init & commit
$commands = array(
    sprintf('git init'),
    sprintf('git remote add static git@github.com:ericclemmons/ericclemmons.github.com.git && git fetch static'),
    sprintf('git symbolic-ref HEAD refs/heads/build'),
    sprintf('git add --all', $staticDir),
    sprintf('git commit -m "Automated Build on %s"', date('c')),
);

$error = false;
while (($command = array_shift($commands)) && !$error) {
    $command = sprintf('cd %s && %s', $staticDir, $command);
    passthru($command, $error);
}

// Final reabase & push
if (! $error) {
    passthru(sprintf('cd %s && git show-ref --quiet --verify refs/remotes/static/master && git rebase static/master build', $staticDir));
    passthru(sprintf('cd %s && git push static build:master', $staticDir));
}
